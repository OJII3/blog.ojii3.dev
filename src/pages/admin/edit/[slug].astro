---
import { Icon } from "astro-icon/components";
import { isUnauthorized } from "@/lib/result";
import { loadEditablePost } from "@/pages/admin/_lib/load-editable-post";
import type { EditablePost } from "@/pages/admin/_lib/types";
import EditPost from "../_components/EditPost.astro";
import AdminLayout from "../_layouts/AdminLayout.astro";

export const prerender = false;

const { slug } = Astro.params;

if (!slug) {
	return Astro.redirect("/admin");
}

let postData: EditablePost = { frontmatter: {}, body: "", sha: "" };
let errorMsg = "";

const loadResult = await loadEditablePost(slug, Astro.request.headers);

if (isUnauthorized(loadResult)) {
	return Astro.redirect("/login");
}

if (!loadResult.ok) {
	errorMsg = loadResult.error;
} else {
	postData = loadResult.value;
}
---

<AdminLayout title={`Edit: ${slug}`}>
	<main class="mx-auto min-h-dvh max-w-lg px-2">
		{
			errorMsg ? (
				<div class="flex min-h-[50vh] flex-col items-center justify-center">
					<div class="text-center">
						<Icon
							name="tabler:alert-circle"
							class="text-error mx-auto size-10"
						/>
						<p class="text-error mt-2 text-sm">{errorMsg}</p>
						<a href="/admin" class="btn btn-ghost btn-sm mt-4">
							<Icon name="tabler:arrow-left" class="size-4" />
						</a>
					</div>
				</div>
			) : (
				<EditPost slug={slug} initialData={postData} />
			)
		}
	</main>
</AdminLayout>
