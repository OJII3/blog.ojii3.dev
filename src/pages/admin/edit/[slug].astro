---
import EditPost from "@/pages/admin/_components/EditPost.astro";
import AdminLayout from "@/pages/admin/_layouts/AdminLayout.astro";
import { loadEditablePost } from "@/pages/admin/_lib/load-editable-post";
import type { EditablePost } from "@/pages/admin/_lib/types";

export const prerender = false;

const { slug } = Astro.params;

if (!slug) {
	return Astro.redirect("/admin");
}

let postData: EditablePost = { frontmatter: {}, body: "", sha: "" };
let errorMsg = "";

const loadResult = await loadEditablePost(slug, Astro.request.headers);

if (loadResult.status === "unauthorized") {
	return Astro.redirect("/login");
}

if (loadResult.status === "error") {
	errorMsg = loadResult.message;
}

if (loadResult.status === "ok") {
	postData = loadResult.post;
}
---

<AdminLayout title={`Edit: ${slug}`}>
	<main
		class="container mx-auto grid min-h-dvh max-w-5xl grid-rows-[auto_1fr] p-4"
	>
		<div class="mb-4 flex items-center justify-between">
			<h1 class="text-gray-7 text-xl font-bold">Edit: {slug}</h1>
		</div>

		{
			errorMsg ? (
				<div class="rounded-lg border border-red-300 bg-red-50 p-4 text-red-700">
					<p class="font-semibold">Error loading post</p>
					<p>{errorMsg}</p>
					<a href="/admin" class="mt-2 inline-block text-sm underline">
						Back to Admin
					</a>
				</div>
			) : (
				<div class="bottom-0 h-full flex-1">
					<EditPost slug={slug} initialData={postData} />
				</div>
			)
		}
	</main>
</AdminLayout>
