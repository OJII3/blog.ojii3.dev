---
import { Icon } from "astro-icon/components";
import { SITE_HEADER_TRANSITION_NAME } from "../constants";
import GlobalLayout from "../features/_layouts/GlobalLayout.astro";
import SearchForm from "../features/search/_components/SearchForm.astro";
import SearchResult from "../features/search/_components/SearchResult.astro";
---

<GlobalLayout title="Search">
	<main class="mx-auto max-w-[1096px] p-4">
		<div class="flex flex-col gap-8">
			<div
				class="flex items-center gap-4 p-4"
				transition:name={SITE_HEADER_TRANSITION_NAME}
			>
				<a
					href="/"
					class="group"
					aria-label="Go back to home"
					data-astro-history="auto"
				>
					<span
						class="border-gray-5 flex h-12 w-12 items-center justify-center rounded-full border-2 p-2 duration-100"
					>
						<Icon name="tabler:arrow-left" class="h-6 w-6" />
					</span>
				</a>
				<SearchForm />
			</div>

			<SearchResult />
		</div>
	</main>

	<template id="search-result-template">
		<a
			class="%%borderColor%% 2x:w-[200px] 2x:h-[200px] 2x:max-w-[200px] flex h-[calc(50dvw-32px)] max-w-full min-w-full flex-col gap-2 overflow-hidden rounded-2xl border-2 p-4 duration-100 hover:shadow-lg"
			href="%%url%%"
		>
			<h3 class="text-gray-5 text-xs">%%title%%</h3>
			<p class="overflow-hidden">
				<span class="text-sm font-bold overflow-ellipsis">%%excerpt%%</span>
			</p>
		</a>
	</template>
</GlobalLayout>

<script is:inline>
	const initSearch = () => {
		const borderColors = [
			"border-rose-500",
			"border-orange-500",
			"border-yellow-500",
			"border-lime-500",
			"border-emerald-500",
			"border-indigo-500",
			"border-purple-500",
		];
		const getIndexByDate = (dateString) => {
			const date = new Date(dateString);
			return date.getDate() % borderColors.length;
		};

		const searchInput = document.querySelector("#search");
		const resultsContainer = document.querySelector("#results");
		const template = document.querySelector("#search-result-template");

		searchInput.addEventListener("input", async (e) => {
			// Pagefindのスクリプトを最初の検索時にのみ読み込み
			if (e.target.dataset.loaded !== "true") {
				e.target.dataset.loaded = "true";
				window.pagefind = await import("/pagefind/pagefind.js");
			}

			const search = await window.pagefind.search(e.target.value);

			// 以前の検索結果をクリア
			resultsContainer.innerHTML = "";

			// 新しい検索結果を追加
			for (const result of search.results) {
				const data = await result.data();
				const borderColor = borderColors[getIndexByDate(data.meta.date)];
				console.log(borderColor);
				const resultElement = document.createElement("div");
				resultElement.innerHTML = template.innerHTML
					.replace("%%borderColor%%", borderColor)
					.replace("%%url%%", data.url)
					.replace("%%title%%", data.meta.title)
					.replace("%%excerpt%%", data.excerpt);
				resultsContainer.appendChild(resultElement.firstElementChild);
			}
		});

		// 確定時に入力値をクエリパラメータに反映
		searchInput.closest("form")?.addEventListener("submit", (e) => {
			e.preventDefault();
			const query = searchInput.value;
			const url = new URL(window.location);
			url.searchParams.set("search", query);
			window.history.replaceState(null, "", url);
		});

		// URLのクエリパラメータからデフォルト検索語を設定
		const urlParams = new URLSearchParams(window.location.search);
		const query = urlParams.get("search");
		if (query && searchInput.value !== query) {
			searchInput.value = query;
			searchInput.dispatchEvent(new Event("input"));
		}
	};

	document.addEventListener("astro:after-swap", initSearch);
	initSearch();
</script>
