---
import AdminLayout from "@/pages/admin/_layouts/AdminLayout.astro";
import {
	createContentClient,
	type GitHubContentItem,
} from "@/pages/admin/_lib/github";

export const prerender = false;

type ContentResult =
	| { status: "ok"; entries: GitHubContentItem[]; fetchedAt: string }
	| { status: "error"; message: string };

let contentResult: ContentResult = {
	status: "error",
	message: "まだ GitHub API にアクセスしていません。",
};

// YYYY-MM-DD-n format
const DATE_PATTERN = /^\d{4}-\d{2}-\d{2}-\d+$/;

try {
	const client = await createContentClient(Astro.request.headers);
	const listing = await client.listRepoPath("");

	// Filter for directories matching the date pattern
	const filteredEntries = listing
		.filter((item) => item.type === "dir" && DATE_PATTERN.test(item.name))
		.sort((a, b) => b.name.localeCompare(a.name)); // Sort by date descending

	contentResult = {
		status: "ok",
		entries: filteredEntries,
		fetchedAt: new Date().toISOString(),
	};
} catch (error) {
	const message =
		error instanceof Error ? error.message : "未知のエラーが発生しました。";
	contentResult = { status: "error", message };
}
---

<AdminLayout title="Admin | Content overview">
	<main class="max-w-5x container mx-auto p-4">
		<header
			class="navbar bg-base-100 rounded-box border-base-200 mb-6 border shadow-sm"
		>
			<div class="flex-1">
				<a class="btn btn-ghost text-xl">Admin Dashboard</a>
			</div>
			<div class="flex-none items-center gap-4 px-2">
				<button id="admin-logout-btn" class="btn btn-sm btn-error btn-outline">
					Logout
				</button>
			</div>
		</header>

		{
			contentResult.status === "error" ? (
				<div role="alert" class="alert alert-error">
					<h3 class="font-bold">Error fetching content</h3>
					<div class="text-xs">{contentResult.message}</div>
				</div>
			) : (
				<div class="card bg-base-100 border-base-200 h-full">
					<div class="card-body p-0">
						<div class="overflow-x-auto">
							<table class="table-zebra table w-full">
								<thead>
									<tr>
										<th>Post ID</th>
										<th class="text-right">Actions</th>
									</tr>
								</thead>
								<tbody>
									{contentResult.entries.length === 0 ? (
										<tr>
											<td colspan="2" class="py-8 text-center opacity-60">
												No posts found.
											</td>
										</tr>
									) : (
										contentResult.entries.map((item) => (
											<tr>
												<td class="font-mono font-bold">{item.name}</td>
												<td class="flex justify-end gap-2">
													<a
														href={`/admin/edit/${item.name}`}
														class="btn btn-sm btn-primary"
													>
														Edit
													</a>
													<a
														href={`/admin/preview/${item.name}`}
														class="btn btn-sm btn-secondary btn-outline"
													>
														Preview
													</a>
												</td>
											</tr>
										))
									)}
								</tbody>
							</table>
						</div>
					</div>
				</div>
			)
		}
	</main>
</AdminLayout>

<script>
	const { signOut } = await import("@/pages/admin/_lib/auth/auth-client");
	const logoutBtn = document.getElementById("admin-logout-btn");
	logoutBtn?.addEventListener("click", async () => {
		await signOut({
			fetchOptions: {
				onSuccess: () => {
					window.location.href = "/login";
				},
			},
		});
	});
</script>
