---
import { Icon } from "astro-icon/components";
import type { EditablePost } from "@/pages/admin/_lib/types";
import EditDate from "./EditDate.astro";
import EditDraft from "./EditDraft.astro";
import EditTags from "./EditTags.astro";
import EditTitle from "./EditTitle.astro";

interface Props {
	slug: string;
	initialData: EditablePost;
}

const { slug, initialData } = Astro.props;
---

<div class="bg-base-200/50 sticky top-0 z-20 -mx-2 mb-3 backdrop-blur-sm">
	<div class="flex items-center justify-between px-2 py-2">
		<div class="flex items-center gap-2">
			<a href="/admin" class="btn btn-ghost btn-circle btn-sm">
				<Icon name="tabler:arrow-left" class="size-5" />
			</a>
			<span class="truncate font-mono text-sm">{slug}</span>
		</div>
		<div class="flex items-center gap-1">
			<a
				href={`/admin/preview/${slug}`}
				class="btn btn-ghost btn-circle btn-sm"
				title="Preview"
			>
				<Icon name="tabler:eye" class="size-4" />
			</a>
			<button
				type="submit"
				form="edit-form"
				class="btn btn-primary btn-circle btn-sm shadow-sm"
				title="Save"
			>
				<Icon name="tabler:device-floppy" class="size-4" />
			</button>
		</div>
	</div>
</div>

<form
	id="edit-form"
	class="flex flex-col gap-3 pb-4"
	data-slug={slug}
	data-sha={initialData.sha}
>
	<details class="bg-base-200/30 rounded-xl">
		<summary class="text-base-content/70 cursor-pointer px-3 py-2 text-sm">
			Metadata
		</summary>
		<div class="space-y-3 px-3 pb-3">
			<EditTitle value={initialData.frontmatter.title} />
			<div class="grid grid-cols-2 gap-2">
				<EditDate value={initialData.frontmatter.date} />
				<EditDraft value={initialData.frontmatter.draft} />
			</div>
			<EditTags value={initialData.frontmatter.tags} />
		</div>
	</details>

	<textarea
		id="body"
		name="body"
		class="textarea textarea-bordered [field-sizing:content] min-h-[60vh] w-full resize-none font-mono text-sm leading-relaxed"
		spellcheck="false"
		placeholder="Markdown...">{initialData.body}</textarea
	>
</form>

<script>
	import { setupEditPostForm } from "@/pages/admin/_lib/edit-post.client";
	setupEditPostForm();

	const textarea = document.getElementById("body") as HTMLTextAreaElement;
	if (textarea) {
		// field-sizing: content がサポートされていない場合のみ JS フォールバック
		const supportsFieldSizing = CSS.supports("field-sizing", "content");
		if (!supportsFieldSizing) {
			let pending = false;
			const adjustHeight = () => {
				if (pending) return;
				pending = true;
				requestAnimationFrame(() => {
					textarea.style.height = "auto";
					textarea.style.height = textarea.scrollHeight + "px";
					pending = false;
				});
			};
			textarea.addEventListener("input", adjustHeight);
			window.addEventListener("resize", adjustHeight);
			adjustHeight();
		}
	}
</script>
