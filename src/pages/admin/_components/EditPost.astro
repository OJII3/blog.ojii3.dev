---
import type { EditablePost } from "@/pages/admin/_lib/types";
import EditDate from "./EditDate.astro";
import EditDraft from "./EditDraft.astro";
import EditTags from "./EditTags.astro";
import EditTitle from "./EditTitle.astro";

interface Props {
	slug: string;
	initialData: EditablePost;
}

const { slug, initialData } = Astro.props;
---

<form
	id="edit-form"
	class="flex flex-col gap-4"
	data-slug={slug}
	data-sha={initialData.sha}
>
	<div class="flex flex-col gap-4">
		<details
			class="collapse-arrow border-base-300 bg-base-100 rounded-box collapse border"
		>
			<summary class="collapse-title text-xl font-medium">Metadata</summary>
			<div class="collapse-content flex flex-col gap-4">
				<EditTitle value={initialData.frontmatter.title} />
				<EditDate value={initialData.frontmatter.date} />
				<EditTags value={initialData.frontmatter.tags} />
				<EditDraft value={initialData.frontmatter.draft} />
			</div>
		</details>

		<div class="flex flex-col gap-2">
			<label for="body" class="text-base-content text-sm font-bold"
				>Body (Markdown)</label
			>
			<textarea
				id="body"
				name="body"
				class="textarea textarea-bordered min-h-[500px] w-full resize-none overflow-hidden font-mono text-sm leading-normal"
				spellcheck="false">{initialData.body}</textarea
			>
		</div>
	</div>

	<div class="border-base-200 flex justify-end gap-4 border-t py-2">
		<a href="/admin" class="btn btn-outline"> Cancel </a>
		<button type="submit" class="btn btn-primary">
			<span id="btn-text">Save Changes</span>
		</button>
	</div>
</form>

<script>
	import { setupEditPostForm } from "@/pages/admin/_lib/edit-post.client";
	setupEditPostForm();

	const textarea = document.getElementById("body") as HTMLTextAreaElement;
	if (textarea) {
		const adjustHeight = () => {
			textarea.style.height = "auto";
			textarea.style.height = textarea.scrollHeight + "px";
		};
		textarea.addEventListener("input", adjustHeight);
		// Adjust initially - slight delay to ensure rendering
		requestAnimationFrame(adjustHeight);
	}
</script>
